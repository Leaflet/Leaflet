<!DOCTYPE html>
<html>
<!--
- Demo on using SVG elements with interactive logic, within Leaflet.js. 
- 
- Unlike the earlier Leaflet/SVG integrations, this builds upon the 'ImageOverlay'
- model, treating the SVG as a "picture" of fixed size, relative to the map. 
-
- The application code is given free hands as to which SVG library to use, and
- what to do with it (i.e. whole applications can be crafted).
-->

<head>
	<title>Leaflet debug page</title>

	<link rel="stylesheet" href="../../dist/leaflet.css" />
	<link rel="stylesheet" href="../css/screen.css" />

	<script type="text/javascript" src="../../build/deps.js"></script>
	<script src="../leaflet-include.js"></script>

  <!-- Snap.svg
  -->
  <script src="http://cdn.jsdelivr.net/snap.svg/0.3.0/snap.svg-min.js"></script>

  <!-- for debugging 
  -->
  <style>
    svg.leaflet-image-layer { border: thin solid red; }
  </style>    
</head>
<body>

	<div id="map"></div>
  
	<script type="text/javascript">
		var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
			osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
			osm = L.tileLayer(osmUrl, {maxZoom: 18, attribution: osmAttrib});

		var map = L.map('map');
    osm.addTo(map);
    
		var	bounds = L.latLngBounds(
                   L.latLng( 60.19473, 24.93961 ),   // NW
                   L.latLng( 60.18952, 24.95497 )    // SE
                 );

		map.fitBounds(bounds);

    //---
    // Scale control
    //
    L.control.scale( {
      metric: true,
      imperial: false
    } ).addTo(map);

    //---
    // SVG as an image
    //
    // This is here to show that the existing (0.8.x) 'L.ImageOverlay' already shows
    // SVG images, if they are loaded into an 'img' container.
    //
    if (true) {
      var imageOverlay = new L.ImageOverlay("snapsvg_mascot.svg", bounds, {
        opacity: 0.5,
        interactive: false
      });
      map.addLayer(imageOverlay);
    }

    //---
    // SVG as itself (can include logic)
    //
    if (true) {
      // The '<svg>' element must be created like this, if it's done programmatically.
      // It will roam free in the DOM until Leaflet shows it where to sit.
      //
      var svgElem= L.DomUtil.create('svg');   //document.createElementNS('http://www.w3.org/2000/svg','svg');

      // Add the svg to the map (and through there to the DOM) at large.
      //
      // This needs a patched Leaflet - image source is an SVG element.
      //
      // For some reason, the loading seems more snappy, if we do this here (and not after
      // the SVG has been populated).
      //
      var overlay = L.imageOverlay2( svgElem, bounds, {
        //opacity: 0.8,     // not available

        // This is a bit vague - the croc gets the events even if we have this 'false'.
        //
        interactive: true
      });
    
      // Add SVG element in use and created by Snap.svg
      //
      var S= Snap( svgElem );
    
      // tbd. could possibly include the mascot in the HTML (enclose full demo in one file)
      //
      Snap.load( "snapsvg_mascot.svg", function (root) {    /* (SVG Element) */
        
        // traverse and change attr before SVG is even added to the page
        //
        root.select("polygon[fill='#09B39C']").attr({fill: "#bada55"});

        var g = root.select("g");
        S.append(g);
        g.drag();     // make croc draggable

        // This does not work, trying to disable map panning in the area of the croc. AK150215 
        // 
        //L.DomEvent.disableClickPropagation(g);

        // Needed so that we don't get double dragging - i.e. the croc gets dragged above
        // a stationary map, the map won't move.
        //
        g.mousedown( function(e) {
          L.DomEvent.stop(e);
        } );

        prepareCrocAnim( g );
      } );

      // 100 x 100 m square, from (0,0)
      //
      S.rect( 0,0, 100,100, 10,10 )    // last params: edge rounding radius
        .attr( {
          stroke: "#f00",
          strokeWidth: 2
        } );

      //S.text( 200, 100, "*** SVG ***" );

		  map.addLayer(overlay);
    }

    //---
    // Following code adopted from http://snapsvg.io home page
    //
    function prepareCrocAnim( SVG_croc ) {    // (SVG element)    
      //console.log( "Croc: "+ SVG_croc );

      var SVG_head = SVG_croc.select("#upper-head"),
          SVG_jaw = SVG_croc.select("#upper-jaw"),
          SVG_symbol = SVG_croc.select("#symbol"),
          //
          clearId = [],
          scrollTop = 0;
          
      var pivots = [
          [44, 147],
          [92, 126]
      ];

      close(true);    // start with mouth shut

      function clearTimer() {
          for (var i = 0; i < clearId.length; i++) {
              clearTimeout(clearId[i]);
          }
          clearId = [];
      }

      function close( force ) {   // (boolean)
          clearTimer();

          SVG_head.animate({ 
              transform: "r" + [8, pivots[0][0], pivots[0][1]]
          }, force ? 0 : 500, mina.backin);
          
          SVG_jaw.animate({
              transform: "r" + [37, pivots[1][0], pivots[1][1]]
          }, force ? 0 : 500, mina.backin);

          clearId.push( setTimeout(function() {
              SVG_symbol.animate({
                  transform: "t" + (-70) + "," + (40) + "r" + (40)
              }, force ? 0 : 100);
          }, force ? 0 : 400));
      }

      function open() {
          clearTimer();

          SVG_head.animate({ 
              transform: "r" + [0, pivots[0][0], pivots[0][1]]
          }, 700, mina.elastic);
          
          SVG_jaw.animate({
              transform: "r" + [0, pivots[1][0], pivots[1][1]]
          }, 700, mina.elastic);

          SVG_symbol.animate({
              transform: "t" + (0) + "," + (0) + "r" + (0)
          }, 500, mina.elastic);
      }

      SVG_croc.hover(open, 
          function() {
              clearId.push(setTimeout(close, 200));
      });

    } // prepareCrocAnim
        
	</script>
</body>
</html>
